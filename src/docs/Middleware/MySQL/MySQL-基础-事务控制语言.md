---
title: MySQL-基础-事务控制语言
article: false
category:
  - 中间件
  - MySQL
---
## TCL
- Transaction Control Language 事务控制语言
## 事务
- 一个或一组sql语句组成一个执行单元，这个执行单元要么全部执行，要么全部不执行。
### 事务的特性
- ACID
  - 原子性（Atomicity）：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。
    - 要么转账成功：A减少1000，B增加1000。要么转账失败：AB数据不变
  - 一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态
    - 转账的过程中，数据要一致，A减少1000，B增加1000
  - 隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。
    - 转账的过程中，不能受其他事务的干扰
  - 持久性（Durability）：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的
    - 事务提交之后，事务持久化，体现在将数据保存在磁盘中
![事务](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171436958.png)
- MySQL如何确保事务的这四个特性：
  - 隔离性：事务的隔离级别
  - 持久性：重做日志
  - 原子性和一致性：回滚日志
### 事务的创建
- 隐式事务：事务没有明显的开启和结束的标记
  - 比如insert、update、delete语句
- 显式事务：事务具有明显的开启和结束的标记
  - 前提：必须先设置自动提交功能为禁用
### 并发事务问题
- 脏读：一个事务读到另外一个事务还没有提交的数据。![脏读](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171444403.png)
  - 事务A查询某条数据并修改，但是还没提交，此时事务B查该数据，此时事务B读到了最新修改后的数据
- 不可重复读：一个事务先后读取同一条记录，但两次读取的数据不同，称之为不可重复读![不可重复读](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171447017.png)
  - 事务A查询某条数据，此时事务B修改了该条数据并提交了，此时若事务A又查询了该条数据，此时这条数据和上次查到的数据不同了
- 幻读：一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了”幻影”![幻读](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171448508.png)
  - 事务A查询某条id为1的数据，此时该数据没有值，事务B插入了一条id为1的数据，并提交了事务。然后A事务插入一条id为1的数据，出现了幻读
- 如何解决
  - 对事务进行隔离，事务具有隔离级别
### 事务的隔离级别
- 事务的隔离级别
  - 读未提交
  - 读已提交
  - 可重复读
  - 串行化
    
|  | 脏读 | 不可重复读 | 幻读 |
| :-----| :----: | :----: | :----: |
| read uncommitted | √ | √ | √ |
| read committed | × | √ | √ |
| repeatable read | × | × | √ |
| serializable | × | × | × |

- ×表示解决了该问题
- mysql采用较为平衡的可重复读
- 查看隔离级别`select @@tx_isolation;`
- 设置隔离级别`set session|global transaction isolation level 隔离级别;`
- 串行化：一个事务提交之后，其他事务才能接着运行。虽然解决了所有问题，但是放弃了并发事务的优势，效率较低
- 从上到下，事务隔离级别越高，数据越安全，但是性能越低
## 回滚日志和重做日志
### 缓冲池和数据页
![缓冲池和数据页](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171458666.png)
- 缓冲池(buffer pool)是什么
  - 内存中的一个区域，里面可以缓存磁盘上经常操作的真实数据，在执行增删改查操作时，先操作缓冲池中的数据（若缓冲池没有数据，则从磁盘加载并缓存），以一定频率刷新到磁盘，从而减少磁盘IO，加快处理速度
- 数据页(page)是什么
  - 是InnoDB存储引擎磁盘管理的最小单元，每个页的大小默认为16KB。页中存储的是行数据(每一条记录)
- 事务执行的原理
  - 为了提高性能，MySQL引入了两块区域，分别是缓冲池和内存页
  - 磁盘结构中存储的是多个数据页(例如某个表的.ibd文件)
  - 当提交了事务之后，操作的是MySQL中的数据，没有去操作磁盘，先操作内存(因为操作内存性能较高，减少I/O次数)，查看缓冲池中是否有本次事务想要操作的数据
  - 若没有，去磁盘的数据页中加载某一页的数据到缓冲池中，然后根据事务操作数据，操作完成后，将数据同步到磁盘中，事务执行完毕
- 存在的问题
  - 若服务器宕机了，同步数据失败，内存中的数据丢失，违背了事务的持久化
- 解决问题
  - 用重做日志实现事务的持久性
### 重做日志
- 重做日志(redo log)是什么
  - 重做日志，记录的是事务提交时数据页的物理修改，是用来实现事务的持久性。
- 日志文件的组成部分
  - 重做日志缓冲（redo log buffer），在内存中
  - 重做日志文件（redo log file），在磁盘中
- 作用
  - 当事务提交之后会把所有修改信息都存到该日志文件中, 用于在刷新脏页到磁盘,发生错误时, 进行数据恢复使用。（WAL Write-Ahead Logging机制）
### 回滚日志
- 回滚日志(undo log)
  - 回滚日志，用于记录数据被修改前的信息
- 作用
  - 提供回滚
    - 当delete一条记录时，回滚日志中会记录一条对应的insert记录，反之亦然
    - 当update一条记录时，它记录一条对应相反的update记录。
    - 当执行rollback时，就可以从undo log中的逻辑记录读取到相应的内容并进行回滚。
  - 提供MVCC(多版本并发控制)
### 回滚日志和重做日志的区别
- 重做日志
  - 记录的是数据页的物理变化，服务宕机可用来同步数据
- 回滚日志
  - 记录的是逻辑日志，当事务回滚时，通过逆操作恢复原来的数据
  - 保证了事务的持久性，undo log保证了事务的原子性和一致性
## MVCC

