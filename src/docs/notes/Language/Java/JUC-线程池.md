---
title: JUC-线程池
article: false
category:
  - Java
  - JUC
---
## 线程池(ThreadPool)
- 一种线程使用模式。线程过多会带来调度开销， 进而影响缓存局部性和整体性能。而线程池维护着多个线程，等待着监督管理 者分配可并发执行的任务。这避免了在处理短时间任务时创建与销毁线程的代 价。线程池不仅能够保证内核的充分利用，还能防止过分调度。
### 优势
- 线程池做的工作只要是控制运行的线程数量，处理过程中将任 务放入队列，然后在线程创建后启动这些任务，如果线程数量超过了最大数量， 超出数量的线程排队等候，等其他线程执行完毕，再从队列中取出任务来执行。
### 特点
- 降低资源消耗: 通过重复利用已创建的线程降低线程创建和销毁造成的销耗
- 提高响应速度: 当任务到达时，任务可以不需要等待线程创建就能立即执行。
- 提高线程的可管理性: 线程是稀缺资源，如果无限制的创建，不仅会销耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。
- JUC中的线程池是通过Executor框架实现的，该框架中用到了Executor，Executors，ExecutorService，ThreadPoolExecutor这几个类
### 常用参数
- corePoolSize 线程池的核心线程数
- maximumPoolSize 能容纳的最大线程数
- keepAliveTime 空闲线程存活时间
- unit 存活的时间单位
- workQueue 存放提交但未执行任务的队列
- threadFactory 创建线程的工厂类
- handler 等待队列满后的拒绝策略
## 拒绝策略
- CallerRunsPolicy: 当触发拒绝策略，只要线程池没有关闭的话，则使用调用线程直接运行任务。一般并发比较小，性能要求不高，不允许失败。但是，由于调用者自己运行任务，如果任务提交速度过快，可能导致程序阻塞，性能效率上必然的损失较大
- AbortPolicy: 丢弃任务，并抛出拒绝执行 RejectedExecutionException 异常 信息。线程池默认的拒绝策略。必须处理好抛出的异常，否则会打断当前的执 行流程，影响后续的任务执行。
- DiscardPolicy: 直接丢弃，其他啥都没有
- DiscardOldestPolicy: 当触发拒绝策略，只要线程池没有关闭的话，丢弃阻塞 队列 workQueue 中最老的一个任务，并将新任务加入
### 决定影响拒绝策略的三个参数
- corePoolSize、workQueue、maximumPoolSize
- 当提交任务数大于 corePoolSize 的时候，会优先将任务放到 workQueue 阻塞队列中。当阻塞队列饱和后，会扩充线程池中线程数，直到达到maximumPoolSize 最大线程数配置。此时，再多余的任务，则会触发线程池的拒绝策略了。
## 几种常用的线程池
### 可缓存线程池
- `newCachedThreadPool`创建一个可缓存线程池，如果线程池长度超过处理需要，可灵活回收空 闲线程，若无可回收，则新建线程
- 特点
  - 线程池中数量没有固定，可达到最大值（Interger. MAX_VALUE
  - 线程池中的线程可进行缓存重复利用和回收（回收默认时间为1分钟
  - 当线程池中，没有可用线程，会重新创建一个线程
- 使用场景
  - 适用于创建一个可无限扩大的线程池，服务器负载压力较轻，执行时间较 短，任务多的场景
### 可重用固定线程数的线程池
- `newFixedThreadPool`创建一个可重用固定线程数的线程池
- 作用
  - 创建一个可重用固定线程数的线程池，以共享的无界队列方式来运行这 些线程。在任意点，在大多数线程会处于处理任务的活动状态。如果在所有线 程处于活动状态时提交附加任务，则在有可用线程之前，附加任务将在队列中 等待。如果在关闭前的执行期间由于失败而导致任何线程终止，那么一个新线 程将代替它执行后续的任务(如果需要)。在某个线程被显式地关闭之前，池 中的线程将一直存在。
- 特点
  - 线程池中的线程处于一定的量，可以很好的控制线程的并发量
  - 线程可以重复被使用，在显示关闭之前，都将一直存在
  - 超出一定量的线程被提交时候需在队列中等待
- 使用场景
  - 适用于可以预测线程数量的业务中，或者服务器负载较重，对线程数有严格限制的场景
### 使用单个 worker 线程的 Executor
- `newSingleThreadExecutor`创建一个使用单个 worker 线程的 Executor，以无界队列方式来运行该 线程
- 作用
  - (注意，如果因为在关闭前的执行期间出现失败而终止了此单个线程， 那么如果需要，一个新线程将代替它执行后续的任务)。可保证顺序地执行各 个任务，并且在任意给定的时间不会有多个线程是活动的。与其他等效的newFixedThreadPool不同，可保证无需重新配置此方法所返回的执行程序即 可使用其他的线程。
- 特点
  - 线程池中最多执行1个线程，之后提交的线程活动将会排在队列中以此 执行
- 使用场景
  - 适用于需要保证顺序执行各个任务，并且在任意时间点，不会同时有多个 线程的场景