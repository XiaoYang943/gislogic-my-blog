---
title: MySQL-优化-索引优化
article: false
category:
  - 中间件
  - MySQL
---
## 索引
- 索引(index)是什么：
  - 是帮助MySQL**高效管理数据**的**数据结构**
- 索引的作用：
  - 因为不用全表遍历，能提高数据检索的效率，降低数据库的IO成本
  - 通过索引列对数据进行排序，降低数据排序的成本，降低了CPU的消耗
## 索引分类
### 按字段分类
- 主键索引(PRIMARY)
  - 如何创建
    - 在建表时，若指定了主键，则自动添加主键索引
  - 是否唯一
    - 因为主键是唯一的，所以主键索引也是唯一的
  - 作用
    - 给主键添加索引
- 唯一索引(UNIQUE)
  - 如何创建
    - 当给字段添加了唯一约束时，则自动添加唯一索引
  - 是否唯一
    - 可以有多个
  - 作用
    - 避免字段中数据的重复
- 常规索引(INDEX)
  - 如何创建
    - `CREATE INDEX 索引名称 ON 表名(字段名...);`
  - 作用
    - 快速定位数据
  - 是否唯一
    - 可以有多个
- 全文索引(FULLTEXT)
  - 是否唯一
    - 可以有多个
### 按索引存储内容分类
- 聚集索引
- 非聚集索引
### 按索引作用范围分类
- 单列索引
  - 一个索引作用于一个字段
- 组合索引
  - 一个索引作用于多个字段
## 索引如何高效管理数据
- 除了管理数据本身之外，MySQL数据库系统还维护着B+树这种数据结构，该数据结构和真实数据存在引用关系，可以在这些数据结构上实现高级查找算法，实现高效管理数据
### 发现问题
- 举例：当没有加索引时，根据id查数据
  - 逐条地比对数据，判断是否和给定id相同...直到找到该条数据
  - 找到后，不停止遍历，继续遍历完整张表，性能低(全表搜索)
### 解决问题
- MySQL的InnoDB存储引擎给加了索引的字段维护一个B+树

## 聚集索引和非聚集索引
- 这张表的主键是id字段，聚集索引的B+树结构的叶子节点保存的是主键id值和该记录的所有数据
- 给这张表的name字段加个索引，非聚集索引的B+树结构的叶子节点保存的是name值和其主键id值
![举个栗子](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171309917.png)
### 聚集索引
- 聚集索引(Clustered Index)是什么
  - 将真实数据和索引放在一起，叫聚集索引
- 特点
  - 索引结构的叶子节点保存的是该行的数据
  - 每张表必须且只有一个聚集索引
- 什么索引才能作为聚集索引
  - 如果表存在主键，该主键索引就是聚集索引
  - 如果表不存在主键，将使用第一个唯一索引作为聚集索引
  - 如果表没有主键，或没有合适的唯一索引，则InnoDB会自动生成一个rowid作为隐藏的聚集索引
### 非聚集索引
- 二级索引、辅助索引、非聚集索引(Secondary Index)是什么
  - 将真实数据与索引分开存储，叫非聚集索引
- 特点
  - 索引结构的叶子节点保存的是对应的主键信息
  - 一张表可以存在多个非聚集索引
### 回表查询
- 回表查询是什么
  - 通过二级索引找到对应的主键值，再到聚集索引中查找整行数据，这个过程就是回表![回表查询](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171311170.png)
- 回表查询存在的问题
  - 回表查询会导致查询效率降低，是慢查询的一种情况
- 如何判断sql是否出现了回表查询的问题
  - 可以使用EXPLAIN关键字查看某SQL是否出现了回表查询这种情况
- 避免回表查询的方法
  - 修改sql语句，使其走覆盖索引

## 覆盖索引
- 什么是覆盖索引
  - 覆盖索引是指查询使用了索引，并且需要返回的数据在该索引中一次性能全部查到
- 有什么作用
  - 避免回表查询(慢查询)
  - 避免超大深度分页(慢查询)
### 避免回表查询
- 举例
  - id是主键
  - 给name加索引
  - gender不加索引
![覆盖索引案例](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308172051189.png)
### 避免超大深度分页
- 场景
  - 在数据量比较大时，如果进行limit分页查询，在查询时，越往后，分页查询效率越低。![limit分页查询耗时对比](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171330470.png)
- 如何避免
  - 一般分页查询时，通过创建覆盖索引能够比较好地提高性能，可以通过覆盖索引加子查询形式进行优化![分页查询优化](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171331314.png)

## 索引的创建原则
- 索引的种类：
  - 主键索引
  - 唯一索引
  - 根据业务创建的索引(复合索引)
- 创建原则
  1. 针对于数据量较大(单表超过10w条数据)，且查询比较频繁的表建立索引。
  2. 针对于常作为查询条件（where）、排序（order by）、分组（group by）操作的字段建立索引。
  3. 尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高。例如按照address查询时，address字段的区分度不高，使用索引的效率不高![区分度高](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171337900.png)
  4. 如果是字符串类型的字段，字段的长度较长，可以针对于字段的特点，建立前缀索引。![前缀索引](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171339183.png)
  5. 尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率。
  6. 要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价也就越大，会影响增删改的效率。
  7. 如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询。
## 索引失效的情况
### 违反了最左前缀法则
- 最左前缀法则是什么
  - 当有多个索引时，其索引是有顺序的，sql语句的查询条件中，使用and拼接查询条件时，需要遵循一些规则
- 走索引的情况![正常情况](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171347592.png)
- 索引失效的情况![失效情况](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171351165.png)

### 范围查询右边的列不能使用索引
![范围查询右边的列不能使用索引](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171355714.png)
### 不要在索引列上进行运算操作
![不要在索引列上进行运算操作](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171357971.png)
### 字符串不加单引号，可能导致索引失效
- 没有对字符串加单引号， MySQL的查询优化器，会自动的进行类型转换，造成索引失效。
![字符串不加单引号，可能导致索引失效](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171359252.png)
### 模糊查询可能导致索引失效
- 以%开头的Like模糊查询，索引失效。如果仅仅是尾部模糊匹配，索引不会失效。如果是头部模糊匹配，索引失效
![模糊查询可能导致索引失效](https://blog-image-9943.oss-cn-beijing.aliyuncs.com/202308171401456.png)










